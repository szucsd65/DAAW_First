extends layout

block content
  .container.mt-5
    .row.justify-content-center
      .col-lg-8
        if equipment
          article.card.shadow-lg.border-0.rounded-4.overflow-hidden
            .position-relative.overflow-hidden(style="height: 300px;")
              if equipment.tipus === 'Piscina' && equipment.image
                img.img-fluid.w-100(src=equipment.image style="height: 100%; object-fit: cover;")
              else
                .d-flex.align-items-center.justify-content-center.bg-gradient-primary.text-white.h-100.fs-1.fw-bold.text-uppercase
                  | #{equipment.tipus || 'Facility'}

            .card-body.p-5
              h1.display-5.fw-bold.mb-4
                | #{equipment.nom && !equipment.nom.includes('nom,"horari"') ? equipment.nom.split(',')[0].replace(/"/g, '').trim() : (equipment.tipus || 'Facility')}
              
              .row.mb-5
                .col-md-6
                  .info-card.bg-light.p-4.rounded-3.mb-4
                    h6.text-muted.mb-3.text-uppercase Facilities Type
                    .h4.text-primary= equipment.tipus || 'Unknown'
                  .info-card.bg-light.p-4.rounded-3
                    h6.text-muted.mb-3 Location Details
                    ul.list-unstyled
                      li.mb-3
                        strong #{(equipment.localitzacio || '').replace(/"/g, '').trim() || 'Tarragona'}
                      li.mb-3
                        | District: 
                        span.fw-medium= (equipment.districte || '').replace(/"/g, '').trim() || 'Central'
                      if equipment.telefon
                        li= equipment.telefon.replace(/"/g, '')
                
                .col-md-6
                  .map-container.rounded-3.overflow-hidden.shadow-sm.mb-4(style="height: 250px;")
                    #equipmentMap
                  .text-center
                    a.btn.btn-outline-primary.btn-lg(href="https://maps.google.com/maps?q=" + equipment.latitud + "," + equipment.longitud target="_blank")
                      i.fas.fa-external-link-alt.me-1 Map (opens new tab)

              .reviews-section
                h3.mb-4 Reviews & Ratings
                if user && user.role === 'admin'
                  a.btn.btn-success.mb-4(href="/equipments/" + equipment._id + "/edit") Edit Equipment
                
                .row.align-items-center.mb-4
                  .col-md-4.text-center
                    .display-1.text-warning #{equipment.averageRating ? equipment.averageRating.toFixed(1) : 'N/A'}
                    .h6.text-muted #{equipment.reviews ? equipment.reviews.length : 0} reviews
                
                .col-12
                  if equipment.reviews && equipment.reviews.length
                    each review in equipment.reviews.slice(0, 5)
                      .review-card.border-bottom.pb-4.mb-4
                        .d-flex.align-items-start
                          .flex-shrink-0 Rating: #{review.rating}/5
                          .flex-grow-1.ms-3
                            h6.mb-1= review.userName || 'Anonymous'
                            .small.text-muted= review.createdAt ? new Date(review.createdAt).toLocaleDateString() : ''
                            p.mb-0= review.comment
                  else
                    .text-center.py-5
                      p.lead.text-muted No reviews yet. Be the first!

                  if user
                    form#reviewForm(method="POST" action="/equipment/" + equipment._id + "/review")
                      .row.g-3
                        .col-md-3
                          label Rating (1-5)
                          select#rating.form-select(name="rating" required)
                            option(value="") Select...
                            option(value="5") 5
                            option(value="4") 4
                            option(value="3") 3
                            option(value="2") 2
                            option(value="1") 1
                        .col-md-6
                          label Comment
                          textarea#comment.form-control(name="comment" rows="3" placeholder="Share your experience...")
                        .col-md-3.d-flex.align-items-end
                          button.btn.btn-primary.w-100(type="submit") Add Review

        else
          .col-12
            .alert.alert-warning.text-center
              h3 Equipment Not Found
              p The requested facility could not be found.
              a.btn.btn-primary(href="/equipments") Back to Facilities

  script.
    if (typeof L !== 'undefined' && equipment && equipment.latitud && equipment.longitud) {
      var map = L.map('equipmentMap').setView([equipment.latitud, equipment.longitud], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.marker([equipment.latitud, equipment.longitud]).addTo(map)
        .bindPopup('<strong>' + (equipment.nom || equipment.tipus || 'Facility') + '</strong>');
    }